events {
    worker_connections 1024;
}

http {
    # Enable proper MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Increase buffer sizes for better performance
    proxy_buffers 8 16k;
    proxy_buffer_size 32k;

    server {
        listen 8080;
        server_name _;

        # Main location block - proxy everything to Streamlit
        location / {
            # Smart CSP handling based on context
            set $csp_frame_ancestors "";
            
            # Check if being accessed from 12taste.com domains
            if ($http_referer ~* "^https://(www\.)?12taste\.com") {
                set $csp_frame_ancestors "frame-ancestors https://www.12taste.com https://12taste.com 'self';";
            }
            
            # Check if being accessed directly (no referrer or from same origin)
            if ($http_referer = "") {
                set $csp_frame_ancestors "frame-ancestors 'self';";
            }
            
            # Check if from same origin
            if ($http_referer ~* "^https://fifi-eu-121263692901\.europe-west1\.run\.app") {
                set $csp_frame_ancestors "frame-ancestors 'self';";
            }
            
            # Don't apply CSP to component iframes (about:srcdoc or blob URLs)
            if ($http_referer ~* "(about:|blob:)") {
                set $csp_frame_ancestors "";
            }
            
            # Apply CSP header only if we have a value
            if ($csp_frame_ancestors != "") {
                add_header Content-Security-Policy $csp_frame_ancestors always;
            }
            
            # CORS headers for JavaScript components
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            
            # Handle OPTIONS preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Headers "*";
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type "text/plain; charset=utf-8";
                add_header Content-Length 0;
                return 204;
            }
            
            # WebSocket support (crucial for Streamlit)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Important headers for proper proxying
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Frame-Options "";
            
            # Disable buffering for Server-Sent Events
            proxy_buffering off;
            
            # Increase timeouts for long-running requests
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
            
            # Forward to Streamlit
            proxy_pass http://localhost:8501;
        }
        
        # Special handling for Streamlit's websocket endpoint
        location /_stcore/stream {
            # No CSP headers for WebSocket connections
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://localhost:8501/_stcore/stream;
        }
        
        # Health check endpoint for Cloud Run
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
