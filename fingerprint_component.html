<!DOCTYPE html>
<html>
<head>
    <title>FiFi Fingerprinting</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        #status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .computing { background-color: #cce5ff; color: #004085; }
        #fingerprint-display {
            font-family: monospace;
            background: white;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="status" class="computing">Initializing fingerprinting...</div>
    <div id="fingerprint-display" class="hidden"></div>

    <script>
        // Check Streamlit availability
        console.log('Streamlit object available:', typeof window.Streamlit);
        if (window.Streamlit) {
            console.log('Streamlit methods:', Object.keys(window.Streamlit));
        }
        
        // Disable service worker to prevent CreepJS error
        if ('serviceWorker' in navigator) {
            delete navigator.serviceWorker;
        }
        
        // Session management
        const sessionId = Math.random().toString(36).substring(2, 15);
        console.log('🔍 FiFi CreepJS starting for session:', sessionId);
        
        // Logging function
        function log(message, data = null) {
            console.log(message, data || '');
        }
        
        // Update status display
        function updateStatus(message, type = 'computing') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
        }
        
        // Generate fallback fingerprint
        async function generateFallbackFingerprint() {
            try {
                log('⚠️ Generating fallback fingerprint...');
                
                // Canvas fingerprinting
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 50;
                
                // Draw test patterns
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.font = '11pt Arial';
                ctx.fillText('Canvas fingerprint 💻', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.font = '18pt Arial';
                ctx.fillText('FiFi', 4, 45);
                
                const canvasData = canvas.toDataURL();
                
                // Collect browser properties
                const fingerprint = {
                    canvas: canvasData.slice(-50),
                    screen: {
                        width: screen.width,
                        height: screen.height,
                        colorDepth: screen.colorDepth,
                        pixelRatio: window.devicePixelRatio || 1
                    },
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    languages: navigator.languages ? navigator.languages.join(',') : navigator.language,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    userAgent: navigator.userAgent,
                    plugins: Array.from(navigator.plugins || []).map(p => p.name).join(','),
                    timestamp: Date.now(),
                    // WebGL fingerprinting
                    webgl: await getWebGLFingerprint(),
                    // Audio fingerprinting
                    audio: await getAudioFingerprint()
                };
                
                // Generate hash
                const fpString = JSON.stringify(fingerprint);
                let hash = 0;
                for (let i = 0; i < fpString.length; i++) {
                    const char = fpString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                return `fallback-${Math.abs(hash).toString(16).padStart(10, '0')}`;
            } catch (error) {
                log('❌ Fallback fingerprinting error:', error);
                return `error-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            }
        }
        
        // WebGL fingerprinting
        async function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'no-webgl';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return debugInfo ? 
                    gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 
                    'webgl-supported';
            } catch (e) {
                return 'webgl-error';
            }
        }
        
        // Audio fingerprinting
        async function getAudioFingerprint() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return 'no-audio';
                
                const context = new AudioContext();
                const oscillator = context.createOscillator();
                const analyser = context.createAnalyser();
                const gain = context.createGain();
                const scriptProcessor = context.createScriptProcessor(4096, 1, 1);
                
                gain.gain.value = 0;
                oscillator.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(gain);
                gain.connect(context.destination);
                
                oscillator.start(0);
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        analyser.disconnect();
                        scriptProcessor.disconnect();
                        gain.disconnect();
                        oscillator.stop();
                        context.close();
                        resolve('audio-' + context.sampleRate);
                    }, 100);
                });
            } catch (e) {
                return 'audio-error';
            }
        }
        
        // Main fingerprint detection function
        async function detectFingerprint() {
            log('🚀 Starting fingerprint detection...');
            
            // Initial wait for CreepJS
            updateStatus('Waiting for CreepJS initialization...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const maxAttempts = 30;
            const delayMs = 500;
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                log(`Attempt ${attempt + 1}/${maxAttempts} at ${(Date.now() / 1000).toFixed(1)}s`);
                updateStatus(`Detecting fingerprint... (${attempt + 1}/${maxAttempts})`);
                
                // Method 1: Check for CreepJS global
                if (window.creepjs && window.creepjs.fingerprint) {
                    log('✅ Found fingerprint via window.creepjs');
                    return window.creepjs.fingerprint;
                }
                
                // Method 2: Check DOM for fingerprint
                log('🔎 Attempting DOM scrape...');
                
                // Check multiple possible selectors
                const selectors = [
                    '.ellipsis-all',
                    '.fingerprint-header .ellipsis-all',
                    '#fingerprint-data .ellipsis-all',
                    '.visitor-id',
                    '.creepjs-fingerprint',
                    '.fingerprint',
                    '[data-fingerprint]'
                ];
                
                for (const selector of selectors) {
                    const elements = document.querySelectorAll(selector);
                    log(`Selector "${selector}" found ${elements.length} elements`);
                    
                    for (const el of elements) {
                        const text = (el.textContent || '').trim();
                        if (text) {
                            log(`  Checking text: "${text}"`);
                            
                            // Check for valid fingerprint
                            if (text && 
                                !text.toLowerCase().includes('computing') && 
                                !text.toLowerCase().includes('loading') &&
                                !text.toLowerCase().includes('error') &&
                                text.length > 10 &&
                                /^[a-zA-Z0-9]/.test(text)) {
                                
                                log(`✅ Found valid fingerprint: ${text}`);
                                return text;
                            }
                        }
                    }
                }
                
                // Check for CreepJS completion
                if (!document.body.textContent.includes('CreepJS still computing')) {
                    log('CreepJS computation appears complete, checking again...');
                    
                    // One more thorough check
                    const allElements = document.querySelectorAll('*');
                    for (const el of allElements) {
                        const text = (el.textContent || '').trim();
                        if (text && text.length > 10 && text.length < 100 && 
                            /^[a-f0-9]{8,}$/i.test(text)) {
                            log(`✅ Found fingerprint pattern: ${text}`);
                            return text;
                        }
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            
            // Fallback
            updateStatus('CreepJS timeout - using fallback fingerprinting...', 'warning');
            return await generateFallbackFingerprint();
        }
        
        // Send fingerprint to parent
        function sendFingerprintToParent(fingerprint) {
            log('📤 Sending fingerprint to communication channels...');
            
            // Send to parent window
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'fingerprint',
                    fingerprint: fingerprint,
                    timestamp: Date.now(),
                    session: sessionId
                }, '*');
                log('📤 Fingerprint sent to parent window:', fingerprint);
            }
            
            // Send to Streamlit
            if (window.Streamlit) {
                window.Streamlit.setComponentValue({
                    fingerprint: fingerprint,
                    timestamp: Date.now(),
                    session: sessionId
                });
                log('📤 Fingerprint sent to Streamlit:', fingerprint);
            } else {
                log('⚠️ Streamlit not available!');
            }
        }
        
        // Load CreepJS
        async function loadCreepJS() {
            return new Promise((resolve, reject) => {
                try {
                    updateStatus('Loading CreepJS library...');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js';
                    script.onload = () => {
                        log('✅ CreepJS loaded successfully');
                        resolve();
                    };
                    script.onerror = (error) => {
                        log('❌ CreepJS load error:', error);
                        reject(error);
                    };
                    document.head.appendChild(script);
                } catch (error) {
                    log('❌ Failed to load CreepJS:', error);
                    reject(error);
                }
            });
        }
        
        // Check functions are defined
        console.log('Function check:');
        console.log('- detectFingerprint:', typeof detectFingerprint);
        console.log('- generateFallbackFingerprint:', typeof generateFallbackFingerprint);
        console.log('- sendFingerprintToParent:', typeof sendFingerprintToParent);
        console.log('- loadCreepJS:', typeof loadCreepJS);
        
        // Main execution
        (async function main() {
            console.log('1️⃣ Main function started');
            try {
                // Load CreepJS
                console.log('2️⃣ About to load CreepJS');
                await loadCreepJS();
                
                // Wait a bit for CreepJS to initialize
                console.log('3️⃣ CreepJS loaded, waiting 1 second');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Detect fingerprint
                console.log('4️⃣ About to call detectFingerprint()');
                const fingerprint = await detectFingerprint();
                console.log('5️⃣ detectFingerprint returned:', fingerprint);
                
                // Display result
                const displayEl = document.getElementById('fingerprint-display');
                if (displayEl) {
                    displayEl.textContent = `Fingerprint: ${fingerprint}`;
                    displayEl.classList.remove('hidden');
                    console.log('6️⃣ Updated display element');
                } else {
                    console.error('❌ Display element not found!');
                }
                
                // Update status
                if (fingerprint.startsWith('fallback-')) {
                    updateStatus('✓ Fingerprint generated (fallback method)', 'warning');
                } else if (fingerprint.startsWith('error-')) {
                    updateStatus('✓ Fingerprint generated (with errors)', 'error');
                } else {
                    updateStatus('✓ Fingerprint detected successfully', 'success');
                }
                console.log('7️⃣ Updated status');
                
                // Send to parent
                console.log('8️⃣ About to send fingerprint to parent');
                sendFingerprintToParent(fingerprint);
                
                // Log final result
                console.log('9️⃣ 🎉 Final fingerprint:', fingerprint);
                
            } catch (error) {
                console.error('❌ Critical error in main():', error);
                console.error('Stack trace:', error.stack);
                updateStatus('Failed to generate fingerprint', 'error');
                
                // Send error fingerprint
                const errorFingerprint = `error-${Date.now()}`;
                sendFingerprintToParent(errorFingerprint);
            }
        })();
        
        // Backup execution in case main() fails
        setTimeout(() => {
            console.log('⏰ Backup check after 5 seconds');
            const displayEl = document.getElementById('fingerprint-display');
            if (!displayEl || !displayEl.textContent.includes('Fingerprint:')) {
                console.error('❗ Fingerprint not detected after 5 seconds, forcing detection');
                detectFingerprint().then(fp => {
                    console.log('Backup detection result:', fp);
                    sendFingerprintToParent(fp);
                }).catch(error => {
                    console.error('Backup detection failed:', error);
                });
            }
        }, 5000);
        
        // Listen for parent requests
        window.addEventListener('message', (event) => {
            if (event.data === 'getFingerprint') {
                const fpEl = document.getElementById('fingerprint-display');
                const fp = fpEl.textContent.replace('Fingerprint: ', '');
                if (fp) {
                    sendFingerprintToParent(fp);
                }
            }
        });
    </script>
</body>
</html>
