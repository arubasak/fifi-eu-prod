<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fingerprint Component</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs/3.4.0/fingerprint.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
        }
        #status {
            display: none;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }
        .debug {
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="status"></div>
    <div id="debug" class="debug"></div>

    <script>
    (function() {
        'use strict';
        
        // Configuration
        const CONFIG = {
            SESSION_ID: new URLSearchParams(window.location.search).get('session_id') || 'unknown',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            DEBUG: false
        };
        
        // State management
        const state = {
            status: 'initializing',
            retryCount: 0,
            fingerprintId: null,
            error: null,
            startTime: Date.now()
        };
        
        // Logging helper
        function log(message, data = {}) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                message,
                ...data
            };
            
            console.log(`[Fingerprint] ${message}`, data);
            
            if (CONFIG.DEBUG) {
                const debug = document.getElementById('debug');
                debug.style.display = 'block';
                debug.innerHTML = `<pre>${JSON.stringify(logEntry, null, 2)}</pre>`;
            }
        }
        
        // Update parent window status
        function updateParent(status, data = {}) {
            const message = {
                type: 'fingerprint_status',
                sessionId: CONFIG.SESSION_ID,
                status: status,
                timestamp: Date.now(),
                ...data
            };
            
            try {
                // Send to parent window
                window.parent.postMessage(message, '*');
                
                // Also update Streamlit if available
                if (window.parent.streamlit) {
                    window.parent.streamlit.setComponentValue(message);
                }
                
                log('Parent updated', message);
            } catch (e) {
                log('Failed to update parent', { error: e.message });
            }
        }
        
        // Generate fingerprint
        async function generateFingerprint() {
            try {
                state.status = 'loading';
                updateParent('loading');
                
                // Load FingerprintJS
                const fp = await FingerprintJS.load({
                    monitoring: false,
                    debug: CONFIG.DEBUG
                });
                
                state.status = 'generating';
                updateParent('generating');
                
                // Get fingerprint
                const result = await fp.get();
                
                // Extract components
                const components = result.components;
                const componentData = {
                    canvas: components.canvas?.value?.toString().substring(0, 10),
                    webgl: components.webgl?.value?.toString().substring(0, 10),
                    webglVendor: components.webglVendorAndRenderer?.value?.vendor,
                    timezone: components.timezone?.value,
                    screen: components.screenResolution?.value?.join('x'),
                    colorDepth: components.colorDepth?.value,
                    hardware: components.hardwareConcurrency?.value,
                    platform: components.platform?.value,
                    languages: components.languages?.value?.join(',')
                };
                
                // Generate consistent ID
                const idComponents = [
                    componentData.canvas,
                    componentData.webgl,
                    componentData.timezone,
                    componentData.screen,
                    componentData.hardware
                ].filter(Boolean).join('|');
                
                // Simple hash function
                let hash = 0;
                for (let i = 0; i < idComponents.length; i++) {
                    hash = ((hash << 5) - hash) + idComponents.charCodeAt(i);
                    hash = hash & hash;
                }
                
                const fingerprintId = '00003ff3' + Math.abs(hash).toString(16).padStart(4, '0').substring(0, 4);
                
                state.fingerprintId = fingerprintId;
                state.status = 'completed';
                
                log('Fingerprint generated', {
                    fingerprintId,
                    visitorId: result.visitorId,
                    confidence: result.confidence?.score,
                    components: Object.keys(components).length
                });
                
                // Prepare redirect data
                const redirectData = {
                    event: 'fingerprint_complete',
                    session_id: CONFIG.SESSION_ID,
                    fingerprint_id: fingerprintId,
                    visitor_id: result.visitorId.substring(0, 16),
                    method: 'enhanced_canvas_webgl',
                    privacy: 'high_privacy',
                    working_methods: Object.keys(components).join(','),
                    timestamp: Date.now(),
                    confidence: result.confidence?.score || 0
                };
                
                // Update parent before redirect
                updateParent('completed', {
                    fingerprintId,
                    redirecting: true
                });
                
                // Redirect with data
                const queryString = new URLSearchParams(redirectData).toString();
                const redirectUrl = `${window.location.pathname}?${queryString}`;
                
                log('Redirecting', { url: redirectUrl });
                
                // Small delay to ensure parent receives message
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 250);
                
            } catch (error) {
                handleError(error);
            }
        }
        
        // Error handling
        function handleError(error) {
            state.error = error.message;
            state.retryCount++;
            
            log('Error occurred', {
                error: error.message,
                retryCount: state.retryCount,
                stack: error.stack
            });
            
            if (state.retryCount < CONFIG.MAX_RETRIES) {
                state.status = 'retrying';
                updateParent('retrying', {
                    attempt: state.retryCount,
                    error: error.message
                });
                
                const delay = CONFIG.RETRY_DELAY * state.retryCount;
                log(`Retrying in ${delay}ms...`);
                
                setTimeout(generateFingerprint, delay);
            } else {
                state.status = 'error';
                updateParent('error', {
                    error: error.message,
                    attempts: state.retryCount
                });
                
                // Final fallback - generate simple ID
                const fallbackId = '00003ff3' + Date.now().toString(16).substring(-4);
                log('Using fallback ID', { fallbackId });
                
                setTimeout(() => {
                    const fallbackData = {
                        event: 'fingerprint_complete',
                        session_id: CONFIG.SESSION_ID,
                        fingerprint_id: fallbackId,
                        method: 'fallback',
                        timestamp: Date.now()
                    };
                    
                    const queryString = new URLSearchParams(fallbackData).toString();
                    window.location.href = `${window.location.pathname}?${queryString}`;
                }, 1000);
            }
        }
        
        // Initialize
        function init() {
            log('Initializing fingerprint component', {
                sessionId: CONFIG.SESSION_ID,
                url: window.location.href
            });
            
            // Check if we're in an iframe
            if (window.self !== window.top) {
                log('Running in iframe');
            }
            
            // Start fingerprinting immediately
            updateParent('initializing');
            
            // Small delay to ensure component is fully loaded
            setTimeout(generateFingerprint, 100);
        }
        
        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Handle messages from parent
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'fingerprint_command') {
                log('Received command', event.data);
                
                if (event.data.command === 'retry') {
                    state.retryCount = 0;
                    generateFingerprint();
                }
            }
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', function() {
            if (state.status === 'generating') {
                updateParent('cancelled');
            }
        });
        
    })();
    </script>
</body>
</html>
