<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Debug Fingerprinting</title>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; background-color: #f0f0f0; }
    #debug-output { font-size: 14px; color: #333; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>

  <h1>Debug Output (iframe)</h1>
  <div id="debug-output">Loading...</div>

  <script>
    (function () {
      const sessionIdInHtml = "{SESSION_ID}";
      const rawSessionIdFromPython = window.parent.location.href.split('session_id=')[1]?.split('&')[0] || 'NOT_FOUND_IN_URL';
      
      let debugMessage = "--- iframe JavaScript Started ---\n";
      debugMessage += `Attempted to inject: "{SESSION_ID}"\n`; // This is the literal placeholder
      debugMessage += `sessionIdInHtml (from template): "${sessionIdInHtml}"\n`;
      debugMessage += `Is placeholder present? ${sessionIdInHtml.includes("{SESSION_ID}")}\n`;
      debugMessage += `Type of sessionIdInHtml: ${typeof sessionIdInHtml}\n`;
      debugMessage += `Length of sessionIdInHtml: ${sessionIdInHtml.length}\n`;
      debugMessage += `Raw Session ID from Parent URL: "${rawSessionIdFromPython}"\n`;
      debugMessage += `Parent URL: ${window.parent.location.href}\n`;
      debugMessage += "--- End iframe JavaScript ---";

      document.getElementById('debug-output').textContent = debugMessage;
      console.log(debugMessage);

      // Attempt to immediately redirect with a dummy fingerprint, just to see if redirection works
      // This will trigger a Streamlit rerun
      setTimeout(() => {
          let baseUrl = window.location.origin + window.location.pathname;
          try {
            if (window.parent && window.parent !== window && window.parent.location.href) {
              const parentUrl = new URL(window.parent.location.href);
              baseUrl = parentUrl.origin + parentUrl.pathname;
            }
          } catch (e) { /* Cross-origin, use self origin as fallback */ }

          const url = new URL(baseUrl);
          url.searchParams.set('event', 'fingerprint_complete');
          url.searchParams.set('session_id', sessionIdInHtml.includes("{SESSION_ID}") ? 'debug_injection_failed' : sessionIdInHtml);
          url.searchParams.set('fingerprint_id', 'debug_test_fp');
          url.searchParams.set('method', 'debug_injection_test');
          url.searchParams.set('privacy', 'debug');
          url.searchParams.set('working_methods', 'none');
          url.searchParams.set('timestamp', Date.now());

          if (window.parent && window.parent !== window) {
            window.parent.location.replace(url.toString());
          } else {
            window.location.replace(url.toString());
          }
      }, 500); // Small delay to allow console.log to appear
      
    })();
  </script>
</body>
</html>
