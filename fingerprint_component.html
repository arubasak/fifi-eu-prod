<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Host (one-shot)</title>

  <!-- Dev CSP: allows http: for localhost; drop "http:" in prod if you want HTTPS-only -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' http: https:;
                 script-src  'self' http: https: 'unsafe-inline';
                 connect-src 'self' http: https:;
                 img-src     'self' data: http: https:;
                 style-src   'self' 'unsafe-inline';">

  <style>
    body { margin:0; padding:16px; font-family: system-ui, Segoe UI, Roboto, Arial; }
  </style>
</head>
<body>
  <h3 id="title">FiFi Host</h3>
  <div id="status">Preparing…</div>

  <!-- keep allow-same-origin so CreepJS can run fully in the child -->
  <iframe id="fpSandbox" style="display:none" sandbox="allow-scripts allow-same-origin"></iframe>

<script>
(function () {
  const qs  = new URLSearchParams(location.search);
  const raw = qs.get('session_id') || "{SESSION_ID}";
  const sessionId = (raw && raw !== "{SESSION_ID}") ? raw : ("test_" + Math.random().toString(36).slice(2,9));

  const title  = document.getElementById('title');
  const status = document.getElementById('status');
  const iframe = document.getElementById('fpSandbox');

  // ---------- ONE-SHOT ----------
  const DONE_KEY = `fifi_done_${sessionId}`;
  const done = sessionStorage.getItem(DONE_KEY) === '1';
  const completionForMe =
    qs.get('event') === 'fingerprint_complete' &&
    qs.get('session_id') === sessionId;

  if (completionForMe || done) {
    sessionStorage.setItem(DONE_KEY, '1');
    title.textContent  = 'FiFi Host — Done';
    status.textContent = 'Fingerprint captured. You can close this tab.';
    try {
      const clean = new URL(location.href);
      clean.search = '';
      history.replaceState(null, '', clean.toString());
    } catch {}
    return;
  }

  // ---------- START CHILD ----------
  title.textContent  = 'FiFi Host — Collecting…';
  status.textContent = 'Waiting for sandbox…';

  const childUrl = `./index.html?session_id=${encodeURIComponent(sessionId)}`;
  iframe.src = childUrl;

  let handled = false;
  function handleOnce(payload) {
    if (handled) return;
    handled = true;
    sessionStorage.setItem(DONE_KEY, '1');

    const { fingerprint_id='', method='creepjs_dom', privacy='standard', fuzzy='' } = payload || {};
    if (!fingerprint_id) { status.textContent = 'No fingerprint received.'; return; }

    const base = location.origin + location.pathname;
    const url  = `${base}?event=fingerprint_complete`
               + `&session_id=${encodeURIComponent(sessionId)}`
               + `&fingerprint_id=${encodeURIComponent(fingerprint_id)}`
               + `&method=${encodeURIComponent(method)}`
               + `&privacy=${encodeURIComponent(privacy)}`
               + `&fuzzy=${encodeURIComponent(fuzzy)}`
               + `&timestamp=${Date.now()}`;

    status.textContent = 'Got fingerprint. Finalizing…';
    location.replace(url);
  }

  // Strict origin check: only accept from the child origin
  const childOrigin = new URL(childUrl, location.href).origin;
  window.addEventListener('message', (e) => {
    if (e.origin !== childOrigin) return;
    if (!e.data || e.data.type !== 'fifi:fingerprint_complete') return;
    handleOnce(e.data.payload);
  });

  // Timeout
  setTimeout(() => {
    if (!handled) status.textContent = 'Timed out waiting for sandbox.';
  }, 15000);
})();
</script>
</body>
</html>
