<!-- fingerprint_component.html - Final Attempt -->

<style>
  /* Minimal styling, only apply to the content *within* this component */
  .fifi-fingerprint-container {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
      position: relative; 
  }
  #fp-app { display: none; } /* Hide the CreepJS UI */
  #status { 
      position: absolute; 
      top: 5px; 
      left: 5px; 
      font-family: Arial, sans-serif; 
      font-size: 10px; 
      color: #aaa; 
      white-space: nowrap; 
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 95%;
  }
</style>

<!-- Load CreepJS CSS first for consistent rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/style.min.css">

<div class="fifi-fingerprint-container">
    <!-- Required DOM structure for CreepJS to inject its data into -->
    <div id="fp-app">
      <fingerprint>
        <div id="fingerprint-data">
          <div class="fingerprint-header-container">
            <div class="fingerprint-header">
              <div class="ellipsis-all">FP ID: Computing...</div>
            </div>
          </div>
        </div>
      </fingerprint>
    </div>

    <div id="status">Initializing fingerprint (component)...</div>

    <!-- Load the CreepJS library. It MUST be here inside the iframe. -->
    <script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

    <!-- Main logic: Polling for CreepJS completion -->
    <script>
    (function () {
      // Attempt to read session ID from Python-injected global variable first
      const sessionId = window.FIFI_SESSION_ID || "{SESSION_ID}"; // Fallback to placeholder if global var fails
      const statusEl = document.getElementById('status');
      
      // --- Robustness Check: Session ID Injection ---
      if (!sessionId || sessionId.includes("{SESSION_ID}")) {
          console.error("CRITICAL (component): Session ID still NOT correctly detected. Aborting iframe JS.");
          statusEl.textContent = 'Error: Session ID missing.';
          redirectToStreamlit('error_js_no_session_detected'); 
          return;
      }

      console.log('üîç FiFi CreepJS component script started for session:', sessionId.substring(0, 8));

      // --- State Management: Prevent multiple sends/runs ---
      const PROCESSED_KEY = `fifi_creep_done_${sessionId}`;
      if (window[PROCESSED_KEY]) {
        console.log('‚úÖ (component): Already processed for this session. Exiting early.');
        return;
      }
      let fingerprintSent = false; 
      const startTime = Date.now(); 

      // --- Centralized Redirect Function ---
      function redirectToStreamlit(reason, payload = {}) {
          if (fingerprintSent) return; 
          fingerprintSent = true;
          window[PROCESSED_KEY] = true; 
          
          const elapsedSeconds = ((Date.now() - startTime) / 1000).toFixed(1);
          console.log(`üöÄ (component) Redirecting to Streamlit after ${elapsedSeconds}s. Reason: ${reason}. FP ID: ${(payload.fingerprint_id || 'N/A').substring(0,8)}`);
          
          let baseUrl = window.location.origin + window.location.pathname;
          try {
            if (window.parent && window.parent !== window && window.parent.location.href) {
              const parentUrl = new URL(window.parent.location.href);
              baseUrl = parentUrl.origin + parentUrl.pathname;
            }
          } catch (e) { /* Cross-origin, use self origin as fallback */ }

          const url = new URL(baseUrl);
          url.searchParams.set('event', 'fingerprint_complete');
          url.searchParams.set('session_id', sessionId);
          url.searchParams.set('fingerprint_id', payload.fingerprint_id || `fallback_js_${sessionId.substring(0,8)}_${Date.now().toString(36)}`);
          url.searchParams.set('method', payload.method || reason);
          url.searchParams.set('privacy', payload.privacy || 'high_privacy');
          url.searchParams.set('working_methods', (payload.working_methods || []).join(','));
          url.searchParams.set('timestamp', Date.now());

          if (window.parent && window.parent !== window) {
            window.parent.location.replace(url.toString());
          } else {
            window.location.replace(url.toString());
          }
      }
      
      // Helper to validate a string as a hex hash
      function asHex(s) {
        return (typeof s === 'string' && /^[a-f0-9]{32,64}$/i.test(s)) ? s : null;
      }
      
      // --- Polling Mechanism (from your working old version, slightly refined) ---
      const targetNode = document.querySelector('#fingerprint-data .fingerprint-header .ellipsis-all');

      if (!targetNode) {
        console.error("CRITICAL (component): CreepJS target DOM node not found. Check HTML structure.");
        redirectToStreamlit('fallback_dom_node_missing_polling');
        return;
      }

      let attempts = 0;
      const maxAttempts = 50; // Give CreepJS plenty of time
      const pollDelay = 150; // Check every 150ms

      function attemptFingerprintPolling() {
        if (fingerprintSent) return; 

        const fpText = targetNode.textContent || '';
        const fpMatch = fpText.match(/FP\s*ID:\s*([a-f0-9]{32,64})/i);
        const stableId = fpMatch ? asHex(fpMatch[1]) : null;

        if (stableId) {
          console.log('‚úÖ (component) Fingerprint detected by Polling:', stableId.substring(0, 8));
          redirectToStreamlit('creepjs_polling_success', {
            fingerprint_id: stableId,
            method: 'creepjs_polling',
            privacy: 'standard', 
            working_methods: ['creepjs']
          });
          return;
        }
        
        attempts++;
        if (attempts < maxAttempts) {
          statusEl.textContent = `Waiting for fingerprint (component, attempt ${attempts}/${maxAttempts})...`;
          setTimeout(attemptFingerprintPolling, pollDelay);
        } else {
          console.warn(`‚ö†Ô∏è (component) Max polling attempts reached (${maxAttempts}). CreepJS did not update DOM. Sending fallback.`);
          redirectToStreamlit('fallback_max_polling_attempts_component');
        }
      }
      
      // Start the polling after a small initial delay
      setTimeout(() => {
        console.log('üöÄ (component) Starting fingerprint polling...');
        attemptFingerprintPolling();
      }, 500); // 500ms initial delay

      // --- Safety Net: Absolute Timeout ---
      setTimeout(() => {
        if (!fingerprintSent) {
          console.error('‚è∞ (component) Absolute timeout reached (15s). Sending fallback.');
          redirectToStreamlit('fallback_absolute_timeout_component');
        }
      }, 15000); // Increased absolute timeout to 15 seconds to allow CreepJS time
    })();
    </script>
</div>
