<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <!-- 1. CORRECTED CSS URL (no /docs/) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/style.min.css">
</head>
<body>
  <div id="status" style="font-family: Arial, sans-serif; font-size: 12px; color: #666;">Initializing...</div>

  <!-- 2. ADD ServiceWorker BLOCK (before loading creep.js) -->
  <script>
    (function() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register = function() {
          console.log('üö´ ServiceWorker registration blocked for Streamlit iframe compatibility.');
          return Promise.reject(new Error('ServiceWorker registration disabled in iframe.'));
        };
      }
    })();
  </script>

  <!-- 3. CORRECTED SCRIPT URL (no /docs/) -->
  <script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/creep.js"></script>

  <!-- 4. REFACTORED SCRIPT using the more reliable Official API -->
  <script>
    (async function () {
      const sessionId = "{SESSION_ID}";
      const statusEl = document.getElementById('status');
      const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';

      // Final check to ensure Streamlit provided a session_id
      if (!sessionId || sessionId.includes("{SESSION_ID}")) {
          console.error("CRITICAL: Session ID was not provided by Streamlit. Aborting.");
          statusEl.textContent = 'Error: Missing session identifier.';
          return;
      }
      
      console.log('üîç FiFi CreepJS starting for session:', sessionId.substring(0, 8));

      if (window.fingerprintSent) return;
      window.fingerprintSent = true;
      
      try {
        statusEl.textContent = 'Computing fingerprint...';
        const fp = await creep.get();

        console.log('‚úÖ Fingerprint data received from API:', fp);
        statusEl.textContent = `Fingerprint detected: ${fp.visitorId.substring(0, 12)}... Sending.`;

        const payload = {
          session_id: sessionId,
          fingerprint_id: fp.visitorId,
          method: 'creepjs_api',
          privacy: fp.lies.confidence,
          working_methods: Object.keys(fp)
        };
        const data = JSON.stringify(payload);

        if (navigator.sendBeacon) {
          navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
          console.log('‚úÖ Fingerprint data sent via beacon.');
          statusEl.textContent = 'Secure connection established.';
        } else {
          fetch(BEACON_URL, { method: 'POST', body: data, headers: {'Content-Type': 'application/json'}, keepalive: true });
        }

      } catch (error) {
        console.error('‚ùå Failed to get fingerprint from CreepJS API:', error);
        statusEl.textContent = 'Error computing fingerprint.';
      }
    })();
  </script>
</body>
</html>
