<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting Component</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: Arial, sans-serif;
      background-color: #f0f2f6; /* Streamlit's default background */
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh; /* Make body fill viewport if iframe has height */
      overflow: hidden; /* Prevent scrollbars */
    }
    #status {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
      text-align: center;
      font-weight: bold;
    }
    /* Styles for the CreepJS default output, make it visible but unobtrusive */
    #fp-app {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      margin-bottom: 20px;
    }
    .fingerprint-header-container {
      margin-bottom: 10px;
    }
    .fingerprint-header {
      font-size: 16px;
      font-weight: bold;
      color: #ff6b6b; /* FiFi red color */
    }
    .fuzzy-fp {
      font-size: 12px;
      color: #999;
    }
    .blurred {
      filter: blur(2px); /* Keep it blurred for display */
    }
  </style>
  <!-- CORRECT CSS URL (path includes /docs/) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/style.min.css">
</head>
<body>

<!-- This DOM structure is CRUCIAL for CreepJS to write its output to.
     It MUST be rendered by the browser within the iframe. -->
<div id="fp-app">
  <fingerprint>
    <div id="fingerprint-data">
      <div class="fingerprint-header-container">
        <div class="fingerprint-header">
          <div class="ellipsis-all">FP ID: Computing...</div>
          <div id="fuzzy-fingerprint">
            <div class="ellipsis-all fuzzy-fp">Fuzzy:
              <span>0000000000000000000000000000000000000000000000000000000000000000</span>
            </div>
          </div>
          <div><span class="time">0 ms</span></div>
        </div>
      </div>
    </div>
  </fingerprint>
</div>

<!-- This div is for your script's status messages -->
<div id="status">Initializing CreepJS...</div>

<!-- 1. Block ServiceWorker registration BEFORE loading CreepJS -->
<script>
(function() {
  console.log('üö´ Blocking ServiceWorker registration...');
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register = function() {
      console.log('üö´ ServiceWorker registration blocked for Streamlit iframe compatibility');
      return Promise.reject(new Error('ServiceWorker registration disabled in iframe'));
    };
    Object.defineProperty(navigator.serviceWorker, 'controller', {
      get: function() { return null; }
    });
  }
  console.log('‚úÖ ServiceWorker blocking initialized');
})();
</script>

<!-- 2. Load the CreepJS library from the CORRECT CDN URL (path includes /docs/) -->
<script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

<!-- 3. Your original DOM-scraping logic (corrected and refined) -->
<script>
(function () {
  const sessionId = "{SESSION_ID}"; 
  const statusEl = document.getElementById('status');
  const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';
  
  // --- CRITICAL SESSION ID VALIDATION ---
  if (!sessionId || sessionId.includes("{SESSION_ID}") || sessionId.length < 5) {
      console.error("CRITICAL: Session ID was not provided by Streamlit or is a placeholder/too short. Aborting fingerprinting.");
      statusEl.textContent = 'Error: Missing session identifier. Cannot secure session.';
      return; 
  }

  console.log('üîç FiFi CreepJS starting for session:', sessionId.substring(0, 8));
  
  if (window.fifiFingerprintSent) {
    console.log('‚úÖ Fingerprint already sent for this page load. Skipping duplicate.');
    return;
  }
  window.fifiFingerprintSent = true; 
  
  let fingerprintFound = false; 
  const startTime = Date.now();
  
  function sendFingerprint(payload) {
    if (fingerprintSent) return; 
    fingerprintSent = true;
    
    const elapsedSeconds = ((Date.now() - startTime) / 1000).toFixed(1);
    console.log(`‚úÖ Fingerprint obtained after ${elapsedSeconds}s:`, payload.fingerprint_id);
    statusEl.textContent = `Session secured! ID: ${(payload.fingerprint_id || 'unknown').substring(0, 12)}...`;
    
    const data = JSON.stringify({
      session_id: sessionId,
      fingerprint_id: payload.fingerprint_id,
      method: payload.method,
      privacy: payload.privacy || 'standard', 
      working_methods: payload.working_methods || [],
      timestamp: new Date().toISOString()
    });
    
    if (navigator.sendBeacon) {
      const sent = navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
      if (sent) {
        console.log('‚úÖ Fingerprint data queued for sending via beacon successfully.');
      } else {
        console.error('‚ùå navigator.sendBeacon failed (possibly due to browser limits or network). Falling back to fetch.');
        fetch(BEACON_URL, { method: 'POST', body: data, headers: {'Content-Type': 'application/json'}, keepalive: true })
              .then(() => console.log('‚úÖ Fingerprint data sent via fetch fallback.'))
              .catch(err => console.error('‚ùå Fetch fallback failed:', err));
      }
    } else {
      console.warn('‚ö†Ô∏è navigator.sendBeacon not supported. Using fetch fallback.');
      fetch(BEACON_URL, { method: 'POST', body: data, headers: {'Content-Type': 'application/json'}, keepalive: true })
            .then(() => console.log('‚úÖ Fingerprint data sent via fetch fallback.'))
            .catch(err => console.error('‚ùå Fetch fallback failed:', err));
    }
  }
  
  function tryDomScrape() {
    const header = document.querySelector('#fingerprint-data .fingerprint-header .ellipsis-all');
    const fuzzyEl = document.querySelector('#fuzzy-fingerprint .fuzzy-fp');
    
    if (!header || !fuzzyEl) {
      console.warn('‚ö†Ô∏è Expected CreepJS output DOM elements not found in iframe for scraping.');
      return false; 
    }
    
    const fpText = header.textContent || '';
    const fuzzyTxt = fuzzyEl.textContent || '';
    
    const fpMatch = fpText.match(/FP\s*ID:\s*([a-f0-9]{32,64})/i);
    const fuzzyMatch = fuzzyTxt.match(/Fuzzy:\s*([a-f0-9]{32,64})/i);
    
    const fpId = fpMatch ? fpMatch[1] : null;
    const fuzzy = fuzzyMatch ? fuzzyMatch[1] : null;
    
    if (fpId && fpId !== 'Computing...' && /^[a-f0-9]{32,64}$/i.test(fpId)) {
      console.log('‚úÖ Found fingerprint via DOM scrape:', fpId);
      fingerprintFound = true; 
      sendFingerprint({
        fingerprint_id: fpId,
        fuzzy: fuzzy || '',
        method: 'creepjs_dom', 
        privacy: 'standard', 
        working_methods: ['creepjs_dom_scrape']
      });
      return true; 
    }
    
    return false; 
  }
  
  let attempts = 0;
  const maxAttempts = 50; 
  
  function attemptFingerprint() {
    attempts++;
    
    if (fingerprintFound) {
        return;
    }

    if (tryDomScrape()) {
      return; 
    }
    
    if (attempts < maxAttempts) {
      // MODIFIED: Increase polling interval for DOM scraping
      const delay = attempts < 10 ? 500 : 1000; // 0.5s for first 10, then 1s
      setTimeout(attemptFingerprint, delay);
    } else {
      console.error('‚ùå Max attempts reached for DOM scraping. Fingerprint not found in DOM.');
      statusEl.textContent = 'Fingerprinting failed (DOM not updated or elements missing). Falling back.';
      sendFingerprint({
          fingerprint_id: `fallback_dom_fail_${sessionId.substring(0,8)}_${Date.now().toString(36)}`,
          fuzzy: '',
          method: 'creepjs_dom_fallback',
          privacy: 'high_privacy',
          working_methods: []
      });
    }
  }
  
  // MODIFIED: Increase initial delay before starting polling
  setTimeout(() => {
    console.log('üöÄ Starting fingerprint detection (DOM polling)...');
    attemptFingerprint();
  }, 2000); // 2 second initial delay
})();
</script>
</body>
</html>
