<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    #status { margin-top: 10px; font-size: 12px; color: #666; }
  </style>
  <!-- CreepJS CSS for proper rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/style.min.css">
</head>
<body>
<div id="status">Initializing CreepJS...</div>

<!-- Block ServiceWorker registration -->
<script>
(function() {
  console.log('üö´ Blocking ServiceWorker registration...');
  if ('serviceWorker' in navigator) {
    const originalRegister = navigator.serviceWorker.register;
    navigator.serviceWorker.register = function() {
      console.log('üö´ ServiceWorker registration blocked for Streamlit iframe compatibility');
      return Promise.reject(new Error('ServiceWorker registration disabled in iframe'));
    };
    Object.defineProperty(navigator.serviceWorker, 'controller', {
      get: function() { return null; }
    });
  }
  console.log('‚úÖ ServiceWorker blocking initialized');
})();
</script>

<!-- Load CreepJS -->
<script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

<script>
(function () {
  // Session ID should already be properly quoted by json.dumps
  const sessionId = {SESSION_ID};
  const statusEl = document.getElementById('status');
  const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';
  
  console.log('üîç FiFi CreepJS starting for session:', sessionId.substring(0, 8));
  
  // Wait for CreepJS to render its UI
  setTimeout(function() {
    console.log('üîç Attempting to get fingerprint...');
    
    // CreepJS creates its own UI - look for the visitor ID there
    const creepContainer = document.querySelector('.visitor-info');
    const visitorSpan = document.querySelector('.visitor-info #visitor');
    const fpHeader = document.querySelector('.fingerprint-header');
    
    console.log('üîç CreepJS container found:', !!creepContainer);
    console.log('üîç Visitor span found:', !!visitorSpan);
    
    let visitorId = null;
    
    // Method 1: Check visitor span
    if (visitorSpan && visitorSpan.textContent) {
      visitorId = visitorSpan.textContent.trim();
      console.log('‚úÖ Found visitor ID from span:', visitorId);
    }
    
    // Method 2: Try the API
    if (!visitorId && window.creep && typeof window.creep.get === 'function') {
      console.log('üîç Using CreepJS API...');
      window.creep.get().then(function(fp) {
        console.log('‚úÖ Fingerprint from API:', fp);
        if (fp && fp.visitorId) {
          sendFingerprint(fp.visitorId, 'creepjs_api', fp);
        }
      }).catch(function(err) {
        console.error('‚ùå API error:', err);
      });
    } else if (visitorId) {
      sendFingerprint(visitorId, 'creepjs_dom', null);
    } else {
      // Try one more time after longer delay
      setTimeout(function() {
        const retrySpan = document.querySelector('.visitor-info #visitor');
        if (retrySpan && retrySpan.textContent) {
          visitorId = retrySpan.textContent.trim();
          console.log('‚úÖ Found visitor ID on retry:', visitorId);
          sendFingerprint(visitorId, 'creepjs_dom_retry', null);
        } else {
          console.log('‚ö†Ô∏è Could not find visitor ID after retries');
        }
      }, 2000);
    }
  }, 3000);
  
  function sendFingerprint(visitorId, method, fullData) {
    console.log('üì§ Sending fingerprint:', visitorId, 'via', method);
    statusEl.textContent = 'Fingerprint: ' + visitorId.substring(0, 12) + '...';
    
    const data = JSON.stringify({
      session_id: sessionId,
      fingerprint_id: visitorId,
      method: method,
      timestamp: new Date().toISOString(),
      user_agent: navigator.userAgent
    });
    
    console.log('üì§ Payload:', data);
    
    if (navigator.sendBeacon) {
      const sent = navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
      console.log('üì§ Beacon result:', sent);
      if (sent) {
        statusEl.textContent = 'Secure connection established.';
      } else {
        // Fallback to fetch
        fetch(BEACON_URL, { 
          method: 'POST', 
          body: data, 
          headers: {'Content-Type': 'application/json'}, 
          keepalive: true 
        }).then(function() {
          console.log('‚úÖ Sent via fetch');
          statusEl.textContent = 'Secure connection established.';
        }).catch(function(err) {
          console.error('‚ùå Fetch error:', err);
        });
      }
    }
  }
})();
</script>
</body>
</html>
