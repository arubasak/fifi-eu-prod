<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    #status { margin-top: 10px; font-size: 12px; color: #666; }
  </style>
</head>
<body>
<div id="status">Initializing CreepJS...</div>

<!-- Block ServiceWorker registration BEFORE loading CreepJS -->
<script>
(function() {
  console.log('üö´ Blocking ServiceWorker registration...');
  if ('serviceWorker' in navigator) {
    const originalRegister = navigator.serviceWorker.register;
    navigator.serviceWorker.register = function() {
      console.log('üö´ ServiceWorker registration blocked for Streamlit iframe compatibility');
      return Promise.reject(new Error('ServiceWorker registration disabled in iframe'));
    };
    Object.defineProperty(navigator.serviceWorker, 'controller', {
      get: function() { return null; }
    });
  }
  console.log('‚úÖ ServiceWorker blocking initialized');
})();
</script>

<!-- Load CreepJS from the CORRECT URL with /docs/ -->
<script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

<script>
(function () {
  const sessionId = "{SESSION_ID}";
  const statusEl = document.getElementById('status');
  const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';
  
  console.log('üîç FiFi CreepJS starting for session:', sessionId.substring(0, 8));
  
  // Wait for CreepJS to fully initialize (all tests complete)
  setTimeout(function() {
    console.log('üîç Attempting to get fingerprint...');
    
    // Try to get the fingerprint from the DOM
    const visitorIdElement = document.querySelector('#visitor-id');
    const fpElement = document.querySelector('.fingerprint-header .visit');
    
    let visitorId = null;
    
    // Method 1: Try visitor-id element
    if (visitorIdElement && visitorIdElement.textContent) {
      visitorId = visitorIdElement.textContent.trim();
      console.log('‚úÖ Found visitor ID from #visitor-id:', visitorId);
    }
    // Method 2: Try fingerprint header
    else if (fpElement && fpElement.textContent) {
      visitorId = fpElement.textContent.trim();
      console.log('‚úÖ Found visitor ID from .fingerprint-header:', visitorId);
    }
    // Method 3: Try the API if available
    else if (window.creep && typeof window.creep.get === 'function') {
      console.log('üîç Using CreepJS API...');
      window.creep.get().then(function(fp) {
        console.log('‚úÖ Fingerprint from API:', fp);
        sendFingerprint(fp.visitorId, 'creepjs_api', fp);
      }).catch(function(err) {
        console.error('‚ùå API error:', err);
        statusEl.textContent = 'Fingerprinting error';
      });
      return; // Exit early since API is async
    }
    
    if (visitorId) {
      sendFingerprint(visitorId, 'creepjs_dom', null);
    } else {
      console.log('‚ö†Ô∏è Could not find visitor ID');
      statusEl.textContent = 'Fingerprinting in progress...';
      
      // Try again after a longer delay
      setTimeout(function() {
        const retryId = document.querySelector('#visitor-id');
        if (retryId && retryId.textContent) {
          sendFingerprint(retryId.textContent.trim(), 'creepjs_dom_retry', null);
        }
      }, 3000);
    }
  }, 2500); // Wait 2.5 seconds for all tests to complete
  
  function sendFingerprint(visitorId, method, fullData) {
    console.log('üì§ Sending fingerprint:', visitorId, 'via', method);
    statusEl.textContent = 'Fingerprint: ' + visitorId.substring(0, 12) + '...';
    
    const data = JSON.stringify({
      session_id: sessionId,
      fingerprint_id: visitorId,
      method: method,
      timestamp: new Date().toISOString(),
      user_agent: navigator.userAgent,
      // Include test results if available
      tests_passed: fullData ? Object.keys(fullData).filter(k => fullData[k] !== undefined).length : null
    });
    
    if (navigator.sendBeacon) {
      const sent = navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
      if (sent) {
        console.log('‚úÖ Fingerprint sent via beacon');
        statusEl.textContent = 'Secure connection established.';
      } else {
        console.log('‚ö†Ô∏è Beacon failed, using fetch...');
        fetch(BEACON_URL, { 
          method: 'POST', 
          body: data, 
          headers: {'Content-Type': 'application/json'}, 
          keepalive: true 
        }).then(function() {
          console.log('‚úÖ Fingerprint sent via fetch');
          statusEl.textContent = 'Secure connection established.';
        });
      }
    }
  }
})();
</script>
</body>
</html>
