<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    #status { margin-top: 10px; font-size: 12px; color: #666; }
  </style>
</head>
<body>
<div id="status">Initializing CreepJS...</div>

<!-- Block ServiceWorker registration BEFORE loading CreepJS -->
<script>
(function() {
  console.log('üö´ Blocking ServiceWorker registration...');
  if ('serviceWorker' in navigator) {
    const originalRegister = navigator.serviceWorker.register;
    navigator.serviceWorker.register = function() {
      console.log('üö´ ServiceWorker registration blocked for Streamlit iframe compatibility');
      return Promise.reject(new Error('ServiceWorker registration disabled in iframe'));
    };
    Object.defineProperty(navigator.serviceWorker, 'controller', {
      get: function() { return null; }
    });
  }
  console.log('‚úÖ ServiceWorker blocking initialized');
})();
</script>

<!-- Load CreepJS from the WORKING URL -->
<script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

<script>
(function () {
  const sessionId = "{SESSION_ID}";
  const statusEl = document.getElementById('status');
  const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';
  
  console.log('üîç FiFi CreepJS starting for session:', sessionId.substring(0, 8));
  
  // Wait a bit for CreepJS to initialize
  setTimeout(function() {
    console.log('üîç Checking if CreepJS loaded...');
    console.log('typeof window.creep:', typeof window.creep);
    
    if (window.creep && typeof window.creep.get === 'function') {
      console.log('‚úÖ CreepJS API available, attempting to get fingerprint...');
      
      window.creep.get().then(function(fp) {
        console.log('‚úÖ Fingerprint obtained:', fp);
        statusEl.textContent = 'Fingerprint detected: ' + fp.visitorId.substring(0, 12) + '...';
        
        // Send to your server
        const data = JSON.stringify({
          session_id: sessionId,
          fingerprint_id: fp.visitorId,
          method: 'creepjs_api',
          privacy: fp.confidence ? fp.confidence.score : 'unknown',
          working_methods: Object.keys(fp).filter(function(key) { return fp[key] !== undefined; })
        });
        
        if (navigator.sendBeacon) {
          const sent = navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
          if (sent) {
            console.log('‚úÖ Fingerprint sent via beacon');
            statusEl.textContent = 'Secure connection established.';
          } else {
            console.log('‚ö†Ô∏è Beacon failed, trying fetch...');
            fetch(BEACON_URL, { 
              method: 'POST', 
              body: data, 
              headers: {'Content-Type': 'application/json'}, 
              keepalive: true 
            });
          }
        }
      }).catch(function(err) {
        console.error('‚ùå CreepJS API error:', err);
        statusEl.textContent = 'Fingerprinting error: ' + err.message;
        // Fall back to your existing DOM scraping method
        fallbackToScraping();
      });
    } else {
      console.log('‚ö†Ô∏è CreepJS API not available, falling back to DOM scraping...');
      fallbackToScraping();
    }
  }, 2000); // Give CreepJS 2 seconds to initialize
  
  // Your existing DOM scraping fallback
  function fallbackToScraping() {
    console.log('üîÑ Starting DOM scraping fallback...');
    // Your existing scraping code here
    statusEl.textContent = 'Using fallback fingerprinting...';
  }
})();
</script>
</body>
</html>
