<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
<script>
(function() {
    try {
        const sessionId = "{SESSION_ID}"; 
        
        console.log('üîç FiFi Fingerprinting (FingerprintJS v4): Starting for session', sessionId.substring(0, 8));
        
        // Prevent multiple executions
        if (window.fifi_fp_executed_for_session === sessionId) {
            console.log('üîç FiFi Fingerprinting: Already executed for this session instance.');
            return;
        }
        window.fifi_fp_executed_for_session = sessionId;

        // Load FingerprintJS v4 from CDN
        import('https://openfpcdn.io/fingerprintjs/v4')
            .then(FingerprintJS => FingerprintJS.load())
            .then(fp => fp.get())
            .then(result => {
                // Map FingerprintJS result to existing structure
                const fingerprintId = result.visitorId;
                const method = 'fingerprintjs';
                const workingMethods = ['fingerprintjs'];
                
                // Determine privacy level based on confidence
                let privacy = 'standard';
                if (result.confidence && result.confidence.score < 0.7) {
                    privacy = 'high_privacy';  // Lower confidence suggests privacy measures
                } else if (result.confidence && result.confidence.score < 0.9) {
                    privacy = 'medium_privacy';
                }
                
                console.log("üîç FiFi Fingerprinting (FingerprintJS v4) complete:", {
                    fingerprint_id: fingerprintId, 
                    method: method, 
                    privacy: privacy, 
                    confidence: result.confidence?.score,
                    working: workingMethods.length
                });
                
                // REDIRECT METHOD: Send data via URL parameters (same as original)
                function getAppUrl() {
                    try {
                        if (window.parent && window.parent.location.origin === window.location.origin) {
                            return window.parent.location.origin + window.parent.location.pathname;
                        }
                    } catch (e) {
                        console.warn("Using current window location as fallback");
                    }
                    return window.location.origin + window.location.pathname;
                }
                
                // Build fingerprint URL with parameters
                const appUrl = getAppUrl();
                const fingerprintUrl = `${appUrl}?event=fingerprint_complete&session_id=${sessionId}&fingerprint_id=${encodeURIComponent(fingerprintId)}&method=${encodeURIComponent(method)}&privacy=${encodeURIComponent(privacy)}&working_methods=${encodeURIComponent(workingMethods.join(','))}&timestamp=${Date.now()}`;
                
                console.log("üîç FiFi Fingerprinting: Redirecting with data...");
                
                // Redirect to pass data to Python
                try {
                    if (window.parent && window.parent.location.origin === window.location.origin) {
                        window.parent.location.href = fingerprintUrl;
                    } else {
                        window.location.href = fingerprintUrl;
                    }
                } catch (e) {
                    console.error('Fingerprint redirect failed:', e);
                }
            })
            .catch(fingerprintError => {
                console.error("üö® FingerprintJS failed, using fallback:", fingerprintError);
                
                // Fallback fingerprint generation (same logic as original)
                const fingerprintId = 'fingerprintjs_failed_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const method = 'fallback';
                const privacy = 'high_privacy';
                const workingMethods = [];
                
                console.log("üîç FiFi Fingerprinting: Using fallback fingerprint:", {
                    fingerprint_id: fingerprintId, 
                    method: method, 
                    privacy: privacy, 
                    working: workingMethods.length
                });
                
                // Same redirect mechanism for fallback
                function getAppUrl() {
                    try {
                        if (window.parent && window.parent.location.origin === window.location.origin) {
                            return window.parent.location.origin + window.parent.location.pathname;
                        }
                    } catch (e) {
                        console.warn("Using current window location as fallback");
                    }
                    return window.location.origin + window.location.pathname;
                }
                
                const appUrl = getAppUrl();
                const fallbackUrl = `${appUrl}?event=fingerprint_complete&session_id=${sessionId}&fingerprint_id=${encodeURIComponent(fingerprintId)}&method=${encodeURIComponent(method)}&privacy=${encodeURIComponent(privacy)}&working_methods=${encodeURIComponent(workingMethods.join(','))}&timestamp=${Date.now()}`;
                
                console.log("üîç FiFi Fingerprinting: Redirecting with fallback data...");
                
                try {
                    if (window.parent && window.parent.location.origin === window.location.origin) {
                        window.parent.location.href = fallbackUrl;
                    } else {
                        window.location.href = fallbackUrl;
                    }
                } catch (e) {
                    console.error('Fallback redirect failed:', e);
                }
            });
        
    } catch (error) {
        console.error("üö® FiFi Fingerprinting component caught a critical error:", error);
        
        // Complete error handling - redirect with error information
        function getAppUrl() {
            try {
                if (window.parent && window.parent.location.origin === window.location.origin) {
                    return window.parent.location.origin + window.parent.location.pathname;
                }
            } catch (e) {
                console.warn("Using current window location as fallback");
            }
            return window.location.origin + window.location.pathname;
        }
        
        // Create emergency fallback fingerprint for critical errors
        const emergencyFingerprintId = 'emergency_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const emergencyMethod = 'emergency_fallback';
        const emergencyPrivacy = 'high_privacy';
        const emergencyWorkingMethods = [];
        
        console.log("üö® FiFi Fingerprinting: Using emergency fallback due to critical error");
        
        const appUrl = getAppUrl();
        const errorUrl = `${appUrl}?event=fingerprint_complete&session_id=${sessionId}&fingerprint_id=${encodeURIComponent(emergencyFingerprintId)}&method=${encodeURIComponent(emergencyMethod)}&privacy=${encodeURIComponent(emergencyPrivacy)}&working_methods=${encodeURIComponent(emergencyWorkingMethods.join(','))}&error=${encodeURIComponent(error.message)}&timestamp=${Date.now()}`;
        
        try {
            if (window.parent && window.parent.location.origin === window.location.origin) {
                window.parent.location.href = errorUrl;
            } else {
                window.location.href = errorUrl;
            }
        } catch (e) {
            console.error('‚ùå Emergency error redirect also failed:', e);
            
            // Last resort: try to at least log the session ID for debugging
            console.error('üÜò CRITICAL: All fingerprinting and redirect methods failed for session:', sessionId);
            
            // If even the redirect fails, try a simple reload as absolute last resort
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.location.reload();
                } else {
                    window.location.reload();
                }
            } catch (reloadError) {
                console.error('üí• CATASTROPHIC: Even reload failed. Manual intervention required.', reloadError);
            }
        }
    }
})();
</script>
</body>
</html>
