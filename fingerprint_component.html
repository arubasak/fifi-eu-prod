<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <!-- 1. CORRECTED CSS URL -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/style.min.css">
</head>
<body>
  <div id="status" style="font-family: Arial, sans-serif; font-size: 12px; color: #666;">Initializing...</div>

  <!-- 2. SERVICE WORKER BLOCK -->
  <script>
    (function() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register = function() {
          console.log('🚫 ServiceWorker registration blocked for Streamlit iframe compatibility.');
          return Promise.reject(new Error('ServiceWorker registration disabled in iframe.'));
        };
      }
    })();
  </script>

  <!-- 3. CORRECTED SCRIPT URL -->
  <script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

  <!-- 4. YOUR PROVEN DOM-SCRAPING LOGIC -->
  <script>
    (function () {
      const sessionId = "{SESSION_ID}";
      const statusEl = document.getElementById('status');
      const BEACON_URL = 'https://fifi-beacon-fastapi-121263692901.europe-west4.run.app/fingerprint';
      
      // Final check to ensure Streamlit provided a session_id
      if (!sessionId || sessionId.includes("{SESSION_ID}")) {
          console.error("CRITICAL: Session ID was not provided by Streamlit. Aborting.");
          statusEl.textContent = 'Error: Missing session identifier.';
          return;
      }

      console.log('🔍 FiFi CreepJS starting for session:', sessionId.substring(0, 8));
      
      const PROCESSED_KEY = `fifi_creep_done_${sessionId}`;
      if (window[PROCESSED_KEY]) {
        console.log('✅ Already processed for this session');
        return;
      }
      
      let fingerprintSent = false;
      const startTime = Date.now();
      
      function sendFingerprint(payload) {
        if (fingerprintSent) return;
        fingerprintSent = true;
        window[PROCESSED_KEY] = true;
        
        const elapsedSeconds = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`🔍 Fingerprint obtained after ${elapsedSeconds} seconds:`, payload);
        statusEl.textContent = `Fingerprint detected: ${(payload.fingerprint_id || 'unknown').substring(0, 12)}... Sending to server.`;
        
        const data = JSON.stringify({
          session_id: sessionId,
          fingerprint_id: payload.fingerprint_id,
          method: payload.method,
          privacy: payload.privacy,
          working_methods: payload.working_methods || []
        });
        
        if (navigator.sendBeacon) {
          navigator.sendBeacon(BEACON_URL, new Blob([data], {type: 'application/json'}));
          console.log('✅ Fingerprint data sent successfully via beacon.');
          statusEl.textContent = 'Secure connection established.';
        } else {
          fetch(BEACON_URL, { method: 'POST', body: data, headers: {'Content-Type': 'application/json'}, keepalive: true });
        }
      }
      
      // ... [The rest of your tryDomScrape, fallback, and polling logic remains here] ...
      // Note: This is truncated for brevity, but your full logic should be here.
      // Make sure this is present in your actual file.

      function tryDomScrape() {
        // Your existing DOM scraping function
      }

      function createFallback(reason) {
        // Your existing fallback function
      }

      let attempts = 0;
      const maxAttempts = 30;
      
      function attemptFingerprint() {
        // Your existing polling logic
      }
      
      setTimeout(() => {
        console.log('🚀 Starting fingerprint detection...');
        // This needs your polling/scraping logic to be here to work.
        // For the example, I'll assume your functions are defined above.
        // attemptFingerprint(); 
      }, 1000);

    })();
  </script>
</body>
</html>
