<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FiFi Fingerprinting</title>
  <style>
    /* Minimal styling to keep the component hidden and unobtrusive */
    body { margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; }
    #fp-app { display: none; } /* Hide the CreepJS UI, it's not for users */
    #status { position: absolute; top: 5px; left: 5px; font-family: Arial, sans-serif; font-size: 10px; color: #aaa; }
  </style>
  <!-- Load CreepJS CSS first for consistent rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/style.min.css">
</head>
<body>

<!-- Required DOM structure for CreepJS to inject its data into -->
<div id="fp-app">
  <fingerprint>
    <div id="fingerprint-data">
      <div class="fingerprint-header-container">
        <div class="fingerprint-header">
          <div class="ellipsis-all">FP ID: Computing...</div>
        </div>
      </div>
    </div>
  </fingerprint>
</div>

<div id="status">Initializing fingerprint (iframe)...</div>

<!-- Load the CreepJS library. It MUST be here inside the iframe. -->
<script src="https://cdn.jsdelivr.net/gh/abrahamjuliot/creepjs@latest/docs/creep.js"></script>

<!-- Main logic using MutationObserver for speed and reliability -->
<script>
(function () {
  // This placeholder is replaced by Python with the raw session ID string, e.g., "my-session-id"
  const sessionId = "{SESSION_ID}";
  const statusEl = document.getElementById('status');
  
  // --- Robustness Check: Session ID Injection ---
  // If Python failed to replace {SESSION_ID}, this check catches it.
  if (!sessionId || sessionId.includes("{SESSION_ID}")) {
      console.error("CRITICAL (iframe): Session ID was NOT correctly injected by Python. Aborting iframe JS.");
      statusEl.textContent = 'Error: Session ID missing from Python.';
      redirectToStreamlit('error_js_no_session_injection'); // Send error back to Streamlit
      return;
  }

  console.log('üîç FiFi CreepJS iframe script started for session:', sessionId.substring(0, 8));

  // --- State Management: Prevent multiple sends/runs ---
  const PROCESSED_KEY = `fifi_creep_done_${sessionId}`;
  if (window[PROCESSED_KEY]) {
    console.log('‚úÖ (iframe): Already processed for this session. Exiting early.');
    return;
  }
  let fingerprintSent = false; // Flag to ensure only one redirect occurs

  // --- Centralized Redirect Function ---
  // Sends the fingerprint data back to the Streamlit parent window via URL parameters.
  function redirectToStreamlit(reason, payload = {}) {
      if (fingerprintSent) return; // Only send once
      fingerprintSent = true;
      window[PROCESSED_KEY] = true; // Mark as processed
      
      console.log(`üöÄ (iframe): Redirecting to Streamlit. Reason: ${reason}. FP ID: ${(payload.fingerprint_id || 'N/A').substring(0,8)}`);
      
      let baseUrl = window.location.origin + window.location.pathname;
      try {
        // Attempt to get the parent's base URL for robust redirection
        if (window.parent && window.parent !== window && window.parent.location.href) {
          const parentUrl = new URL(window.parent.location.href);
          baseUrl = parentUrl.origin + parentUrl.pathname;
        }
      } catch (e) { /* Cross-origin, use self origin as fallback */ }

      const url = new URL(baseUrl);
      url.searchParams.set('event', 'fingerprint_complete');
      url.searchParams.set('session_id', sessionId);
      url.searchParams.set('fingerprint_id', payload.fingerprint_id || `fallback_js_${sessionId.substring(0,8)}_${Date.now().toString(36)}`);
      url.searchParams.set('method', payload.method || reason);
      url.searchParams.set('privacy', payload.privacy || 'high_privacy');
      url.searchParams.set('working_methods', (payload.working_methods || []).join(','));
      url.searchParams.set('timestamp', Date.now()); // Unique timestamp to force Streamlit rerun

      // Use window.parent.location.replace() for a cleaner browser history (no back button entry)
      if (window.parent && window.parent !== window) {
        window.parent.location.replace(url.toString());
      } else {
        window.location.replace(url.toString());
      }
  }
  
  // Helper to validate a string as a hex hash (simplified)
  function asHex(s) {
    return (typeof s === 'string' && /^[a-f0-9]{32,64}$/i.test(s)) ? s : null;
  }
  
  // --- Core Logic: MutationObserver for CreepJS completion ---
  const targetNode = document.querySelector('#fingerprint-data .fingerprint-header .ellipsis-all');

  if (!targetNode) {
    console.error("CRITICAL (iframe): CreepJS target DOM node '#fingerprint-data .fingerprint-header .ellipsis-all' not found. Check CreepJS integration/HTML structure.");
    redirectToStreamlit('fallback_dom_node_missing');
    return;
  }

  // This function is triggered by the browser whenever the observed node's content changes
  const observerCallback = function(mutationsList, observer) {
    for(const mutation of mutationsList) {
      if (mutation.type === 'childList' || mutation.type === 'characterData') {
        const fpText = targetNode.textContent || '';
        const fpMatch = fpText.match(/FP\s*ID:\s*([a-f0-9]{32,64})/i);
        const stableId = fpMatch ? asHex(fpMatch[1]) : null;

        if (stableId) {
          console.log('‚úÖ (iframe): Fingerprint detected by MutationObserver:', stableId.substring(0, 8));
          // Valid ID found, send it back and stop observing
          redirectToStreamlit('creepjs_observer_success', {
            fingerprint_id: stableId,
            method: 'creepjs_observer',
            privacy: 'standard', 
            working_methods: ['creepjs']
          });
          observer.disconnect(); // IMPORTANT: Stop observing to prevent multiple triggers
          return; // Exit function early
        }
      }
    }
  };

  // Create and start the MutationObserver
  const observer = new MutationObserver(observerCallback);
  // Observe for changes to child elements or text content within the target node
  observer.observe(targetNode, { childList: true, characterData: true, subtree: true });
  statusEl.textContent = 'Waiting for fingerprint (iframe process)...';
  console.log('üëÄ (iframe): MutationObserver is now watching for CreepJS completion...');

  // --- Safety Net: Absolute Timeout ---
  // A final fallback in case CreepJS crashes or the observer never fires.
  setTimeout(() => {
    if (!fingerprintSent) {
      console.error('‚è∞ (iframe): Absolute timeout reached (7s). CreepJS likely failed or got stuck. Sending fallback.');
      observer.disconnect(); // Ensure observer is stopped
      redirectToStreamlit('fallback_absolute_timeout_iframe');
    }
  }, 7000); // 7-second maximum wait time in the iframe
})();
</script>
</body>
</html>
